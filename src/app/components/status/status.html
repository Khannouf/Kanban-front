@if (isCatModalOpen) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="w-full max-w-md rounded-lg bg-white p-6">
      <h2 class="mb-4 text-xl font-semibold text-black">Nouvelle catégories</h2>
      <form [formGroup]="StatusFormGroup" (ngSubmit)="onSubmit()" class="space-y-4">
        <div>
          <label class="mb-2 block text-sm font-medium text-gray-700">Nom de la catégorie</label>
          <input
            formControlName="name"
            placeholder="Ex: À faire, En cours..."
            class="w-full rounded-lg border border-gray-300 px-4 py-2.5 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 text-black"
          />
        </div>

        <div>
          <label class="mb-2 block text-sm font-medium text-gray-700">Couleur</label>
          <div class="flex items-center gap-3">
            <input formControlName="color" type="color" class="h-12 w-20 cursor-pointer" />
            <input
              formControlName="color"
              type="text"
              placeholder="#000000"
              class="flex-1 text-black rounded-lg border border-gray-300 px-4 py-2.5 font-mono text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
            />
          </div>
          <div class="mt-3 flex gap-5 items-center justify-center">
            <button
              type="button"
              (click)="StatusFormGroup.patchValue({ color: '#ef4444' })"
              class="h-8 w-8 rounded-full bg-red-500 ring-2 ring-offset-2 ring-white hover:ring-red-500"
            ></button>
            <button
              type="button"
              (click)="StatusFormGroup.patchValue({ color: '#f59e0b' })"
              class="h-8 w-8 rounded-full bg-orange-500 ring-2 ring-offset-2 ring-white hover:ring-orange-500"
            ></button>
            <button
              type="button"
              (click)="StatusFormGroup.patchValue({ color: '#eab308' })"
              class="h-8 w-8 rounded-full bg-yellow-500 ring-2 ring-offset-2 ring-white hover:ring-yellow-500"
            ></button>
            <button
              type="button"
              (click)="StatusFormGroup.patchValue({ color: '#22c55e' })"
              class="h-8 w-8 rounded-full bg-green-500 ring-2 ring-offset-2 ring-white hover:ring-green-500"
            ></button>
            <button
              type="button"
              (click)="StatusFormGroup.patchValue({ color: '#3b82f6' })"
              class="h-8 w-8 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-white hover:ring-blue-500"
            ></button>
            <button
              type="button"
              (click)="StatusFormGroup.patchValue({ color: '#8b5cf6' })"
              class="h-8 w-8 rounded-full bg-purple-500 ring-2 ring-offset-2 ring-white hover:ring-purple-500"
            ></button>
            <button
              type="button"
              (click)="StatusFormGroup.patchValue({ color: '#ec4899' })"
              class="h-8 w-8 rounded-full bg-pink-500 ring-2 ring-offset-2 ring-white hover:ring-pink-500"
            ></button>
          </div>
        </div>

        <div class="flex justify-end gap-2 pt-2">
          <button
            type="button"
            (click)="closeCatModal.emit()"
            class="rounded-lg border border-gray-300 px-4 py-2 text-gray-700 hover:bg-gray-50"
          >
            Annuler
          </button>
          <button
            type="submit"
            class="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
          >
            Créer
          </button>
        </div>
      </form>
    </div>
  </div>
}

@if (openUpdateStatusModal) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="w-full max-w-md rounded-lg bg-white p-6 text-black">
      <h2 class="mb-4 text-xl font-semibold">
        Modifier le statut "{{ StatusUpdateformGroup.get('name')?.value }}"
      </h2>
      <form [formGroup]="StatusUpdateformGroup" (ngSubmit)="updateStatus()" class="space-y-4">
        <div>
          <label class="mb-2 block text-sm font-medium text-gray-700">Nom du statut</label>
          <input
            formControlName="name"
            placeholder="Ex: À faire, En cours..."
            class="w-full rounded-lg border border-gray-300 px-4 py-2.5 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
          />
        </div>

        <div>
          <label class="mb-2 block text-sm font-medium text-gray-700">Couleur</label>
          <div class="flex items-center gap-3">
            <input formControlName="color" type="color" class="h-12 w-20 cursor-pointer" />
            <input
              formControlName="color"
              type="text"
              placeholder="#000000"
              class="flex-1 rounded-lg border border-gray-300 px-4 py-2.5 font-mono text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
            />
          </div>
          <div class="mt-3 flex gap-5 items-center justify-center">
            <button
              type="button"
              (click)="StatusUpdateformGroup.patchValue({ color: '#ef4444' })"
              class="h-8 w-8 rounded-full bg-red-500 ring-2 ring-offset-2 ring-white hover:ring-red-500"
            ></button>
            <button
              type="button"
              (click)="StatusUpdateformGroup.patchValue({ color: '#f59e0b' })"
              class="h-8 w-8 rounded-full bg-orange-500 ring-2 ring-offset-2 ring-white hover:ring-orange-500"
            ></button>
            <button
              type="button"
              (click)="StatusUpdateformGroup.patchValue({ color: '#eab308' })"
              class="h-8 w-8 rounded-full bg-yellow-500 ring-2 ring-offset-2 ring-white hover:ring-yellow-500"
            ></button>
            <button
              type="button"
              (click)="StatusUpdateformGroup.patchValue({ color: '#22c55e' })"
              class="h-8 w-8 rounded-full bg-green-500 ring-2 ring-offset-2 ring-white hover:ring-green-500"
            ></button>
            <button
              type="button"
              (click)="StatusUpdateformGroup.patchValue({ color: '#3b82f6' })"
              class="h-8 w-8 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-white hover:ring-blue-500"
            ></button>
            <button
              type="button"
              (click)="StatusUpdateformGroup.patchValue({ color: '#8b5cf6' })"
              class="h-8 w-8 rounded-full bg-purple-500 ring-2 ring-offset-2 ring-white hover:ring-purple-500"
            ></button>
            <button
              type="button"
              (click)="StatusUpdateformGroup.patchValue({ color: '#ec4899' })"
              class="h-8 w-8 rounded-full bg-pink-500 ring-2 ring-offset-2 ring-white hover:ring-pink-500"
            ></button>
          </div>
        </div>
        <div>
          <label class="mb-2 block text-sm font-medium text-gray-700">Ordre</label>
          <input
            formControlName="order"
            placeholder="Ex: 1, 2, 3..."
            type="number"
            class="w-full rounded-lg border border-gray-300 px-4 py-2.5 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
          />
        </div>

        <div class="flex justify-end gap-2 pt-2">
          <button
            type="button"
            (click)="closeUpdateModal()"
            class="rounded-lg border border-gray-300 px-4 py-2 text-gray-700 hover:bg-gray-50"
          >
            Annuler
          </button>
          <button
            type="submit"
            class="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
          >
            Modifier
          </button>
        </div>
      </form>
    </div>
  </div>
}

@if (status()) {
  <div cdkScrollable class="flex h-full flex-nowrap gap-4 overflow-x-auto pb-4 w-full">
    @for (item of sortedStatus(); track item._id) {
      <div
        class="relative min-w-75 w-75 h-full shrink-0 rounded-2xl p-4 overflow-y-auto flex flex-col border-2"
        [style.border-color]="item.color"
      >
        <div class="flex items-start justify-between mb-4">
          <div>
            <h3 class="font-semibold text-lg">{{ item.name }}</h3>
            <p class="text-sm text-gray-500">Ordre: {{ item.order }}</p>
          </div>
          <button
            type="button"
            class="text-gray-400 hover:text-gray-600 w-6 h-6 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center shrink-0 relative"
            (click)="toggleMenu(item._id)"
          >
            <mat-icon>more_vert</mat-icon>
            @if (openMenuId === item._id) {
              <div
                class="absolute right-0 top-8 z-10 rounded-lg border border-gray-200 bg-white shadow-lg whitespace-nowrap"
              >
                <button
                  type="button"
                  class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"
                  (click)="modalUpdateStatus(item)"
                >
                  Modifier
                </button>
                <button
                  type="button"
                  class="block w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50"
                  (click)="deleteStatus(item._id)"
                >
                  Supprimer
                </button>
              </div>
            }
          </button>
        </div>

        <!-- Tasks pour ce status -->
        <div
          cdkDropList
          [id]="'droplist-' + item._id"
          [cdkDropListData]="tasksService.task()"
          [cdkDropListConnectedTo]="getConnectedDropLists()"
          (cdkDropListDropped)="onTaskDrop($event, item._id)"
          class="space-y-3 flex-1"
        >
          @for (task of tasksService.task(); track task._id) {
            @if (task.statusId === item._id) {
              <div
                cdkDrag
                [cdkDragData]="task"
                (cdkDragStarted)="onDragStarted(task)"
              >
                <div
                  class="rounded-lg border border-gray-200 bg-gray-50 p-3 hover:shadow-md transition-shadow cursor-move"
                  [style.border-color]="item.color"
                  (click)="editTask.emit(task)"
                >
                  <h4 class="font-medium text-sm mb-1 text-gray-950">{{ task.name }}</h4>
                  <p class="text-xs text-gray-600 mb-2">{{ task.description }}</p>
                  <div class="flex flex-wrap gap-1">
                    @for (tag of task.tags; track tag) {
                      <span class="rounded-full bg-blue-100 px-2 py-0.5 text-xs text-blue-800">
                        {{ tag }}
                      </span>
                    }
                  </div>
                </div>
              </div>
            }
          } @empty {
            <p class="text-gray-400 text-sm text-center py-2">Aucune tâche</p>
          }
        </div>
      </div>
    }
  </div>
} @else {
  <p class="text-center text-gray-600">Chargement des statuts...</p>
}
